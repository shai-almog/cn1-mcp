<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Jdk8ManagerFromResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mcp</a> &gt; <a href="index.source.html" class="el_package">com.codename1.server.mcp.tools</a> &gt; <span class="el_source">Jdk8ManagerFromResource.java</span></div><h1>Jdk8ManagerFromResource.java</h1><pre class="source lang-java linenums">package com.codename1.server.mcp.tools;

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Locale;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

/**
 * Extracts bundled or remote JDK 8 archives and exposes convenience helpers for locating binaries.
 */
@Component
public class Jdk8ManagerFromResource {
<span class="fc" id="L20">  private static final Logger LOG = LoggerFactory.getLogger(Jdk8ManagerFromResource.class);</span>

  private final GlobalExtractor extractor;
  private final String linuxArchiveResource;
  private final String macArchiveUrl;
  private final String windowsArchiveUrl;
  private final String rootMarker; // e.g. &quot;release&quot;

  /** Creates a manager that resolves the bundled JDK archives using Spring configuration. */
  @Autowired
  public Jdk8ManagerFromResource(
      GlobalExtractor extractor,
      @Value(&quot;${cn1.jdk8.linuxResourcePath:${cn1.jdk8.resourcePath}}&quot;) String linuxArchiveResource,
      @Value(&quot;${cn1.jdk8.macUrl:}&quot;) String macArchiveUrl,
      @Value(&quot;${cn1.jdk8.windowsUrl:}&quot;) String windowsArchiveUrl,
<span class="fc" id="L35">      @Value(&quot;${cn1.jdk8.rootMarker}&quot;) String rootMarker) {</span>
<span class="fc" id="L36">    this.extractor = extractor;</span>
<span class="fc" id="L37">    this.linuxArchiveResource = linuxArchiveResource;</span>
<span class="fc" id="L38">    this.macArchiveUrl = macArchiveUrl;</span>
<span class="fc" id="L39">    this.windowsArchiveUrl = windowsArchiveUrl;</span>
<span class="fc" id="L40">    this.rootMarker = rootMarker;</span>
<span class="fc" id="L41">  }</span>

  /** Convenience constructor for unit tests that only require a Linux archive resource. */
  public Jdk8ManagerFromResource(
      GlobalExtractor extractor, String linuxArchiveResource, String rootMarker) {
<span class="fc" id="L46">    this(extractor, linuxArchiveResource, &quot;&quot;, &quot;&quot;, rootMarker);</span>
<span class="fc" id="L47">  }</span>

  /** Ensures the bundled JDK 8 archive is extracted and returns the {@code javac} binary. */
  public Path ensureJavac8() throws IOException {
<span class="fc" id="L51">    return ensureBinary(&quot;javac&quot;);</span>
  }

  /** Ensures the bundled JDK 8 archive is extracted and returns the {@code java} binary. */
  public Path ensureJava8() throws IOException {
<span class="fc" id="L56">    return ensureBinary(&quot;java&quot;);</span>
  }

  private Path ensureBinary(String binary) throws IOException {
<span class="fc" id="L60">    String os = System.getProperty(&quot;os.name&quot;, &quot;linux&quot;).toLowerCase(Locale.ENGLISH);</span>
<span class="fc" id="L61">    LOG.info(&quot;Resolving bundled JDK8 binary '{}' for operating system {}&quot;, binary, os);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">    if (os.contains(&quot;win&quot;)) {</span>
<span class="fc" id="L63">      return ensureFromUrl(windowsArchiveUrl, true, &quot;Windows&quot;, binary);</span>
    }
<span class="pc bpc" id="L65" title="2 of 4 branches missed.">    if (os.contains(&quot;mac&quot;) || os.contains(&quot;darwin&quot;)) {</span>
<span class="nc" id="L66">      return ensureFromUrl(macArchiveUrl, false, &quot;macOS&quot;, binary);</span>
    }
<span class="fc" id="L68">    return ensureFromResource(linuxArchiveResource, binary);</span>
  }

  private Path ensureFromResource(String resource, String binary) throws IOException {
<span class="pc bpc" id="L72" title="1 of 4 branches missed.">    if (resource == null || resource.isBlank()) {</span>
<span class="fc" id="L73">      throw new IOException(&quot;No bundled JDK8 resource configured for Linux&quot;);</span>
    }
<span class="fc" id="L75">    Path fileNamePath = Path.of(resource).getFileName();</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">    if (fileNamePath == null) {</span>
      // SpotBugs: ensure we throw a friendly error instead of dereferencing a null file name.
<span class="nc" id="L78">      throw new IOException(&quot;Bundled JDK8 resource path must include a file name: &quot; + resource);</span>
    }
<span class="fc" id="L80">    String fileName = fileNamePath.toString();</span>
<span class="fc" id="L81">    String folderName = stripArchiveExtension(fileName);</span>
<span class="fc" id="L82">    GlobalExtractor.ArchiveType type = GlobalExtractor.ArchiveType.fromName(fileName);</span>
<span class="fc" id="L83">    LOG.info(&quot;Ensuring Linux JDK8 resource {} -&gt; folder {}&quot;, resource, folderName);</span>
<span class="fc" id="L84">    Path jdkRoot = extractor.ensureArchiveExtracted(resource, folderName);</span>
<span class="fc" id="L85">    Path root = findJdkRoot(jdkRoot);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">    return resolveBinary(root, type == GlobalExtractor.ArchiveType.ZIP, binary);</span>
  }

  private Path ensureFromUrl(String url, boolean windows, String label, String binary)
      throws IOException {
<span class="pc bpc" id="L91" title="1 of 4 branches missed.">    if (url == null || url.isBlank()) {</span>
<span class="fc" id="L92">      throw new IOException(&quot;No JDK8 download URL configured for &quot; + label);</span>
    }
<span class="fc" id="L94">    String fileName = fileName(url);</span>
<span class="fc" id="L95">    String folderName = stripArchiveExtension(fileName);</span>
<span class="fc" id="L96">    LOG.info(&quot;Ensuring remote JDK8 {} for {} -&gt; folder {}&quot;, url, label, folderName);</span>
<span class="fc" id="L97">    Path jdkRoot = extractor.ensureArchiveExtractedFromUrl(url, folderName);</span>
<span class="fc" id="L98">    Path root = findJdkRoot(jdkRoot);</span>
<span class="fc" id="L99">    return resolveBinary(root, windows, binary);</span>
  }

  private Path findJdkRoot(Path base) throws IOException {
<span class="fc" id="L103">    Path resolved = findJdkRootRecursive(base, 0);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">    return resolved != null ? resolved : base;</span>
  }

  private Path findJdkRootRecursive(Path dir, int depth) throws IOException {
<span class="fc bfc" id="L108" title="All 2 branches covered.">    if (Files.exists(dir.resolve(rootMarker))) {</span>
<span class="fc" id="L109">      return dir;</span>
    }
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">    if (depth &gt;= 4) {</span>
<span class="nc" id="L112">      return null;</span>
    }
<span class="fc" id="L114">    try (var stream = Files.list(dir)) {</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">      for (Path child : (Iterable&lt;Path&gt;) stream::iterator) {</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (!Files.isDirectory(child)) {</span>
<span class="nc" id="L117">          continue;</span>
        }
<span class="fc" id="L119">        Path candidate = findJdkRootRecursive(child, depth + 1);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (candidate != null) {</span>
<span class="fc" id="L121">          return candidate;</span>
        }
<span class="nc" id="L123">      }</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">    }</span>
<span class="nc" id="L125">    return null;</span>
  }

  private Path resolveBinary(Path root, boolean windows, String binary) throws IOException {
<span class="fc bfc" id="L129" title="All 2 branches covered.">    String executableName = windows ? binary + &quot;.exe&quot; : binary;</span>
<span class="fc" id="L130">    Path executable = root.resolve(&quot;bin&quot;).resolve(executableName);</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">    if (!Files.exists(executable)) {</span>
<span class="nc" id="L132">      throw new IOException(binary + &quot; not found at &quot; + executable);</span>
    }
<span class="pc bpc" id="L134" title="1 of 4 branches missed.">    if (!windows &amp;&amp; !Files.isExecutable(executable)) {</span>
<span class="nc" id="L135">      throw new IOException(binary + &quot; not executable at &quot; + executable);</span>
    }
<span class="fc" id="L137">    LOG.debug(&quot;Resolved {} executable at {}&quot;, binary, executable);</span>
<span class="fc" id="L138">    return executable;</span>
  }

  private static String stripArchiveExtension(String name) {
<span class="fc bfc" id="L142" title="All 2 branches covered.">    if (name.toLowerCase(Locale.ENGLISH).endsWith(&quot;.tar.gz&quot;)) {</span>
<span class="fc" id="L143">      return name.substring(0, name.length() - &quot;.tar.gz&quot;.length());</span>
    }
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">    if (name.toLowerCase(Locale.ENGLISH).endsWith(&quot;.tgz&quot;)) {</span>
<span class="nc" id="L146">      return name.substring(0, name.length() - &quot;.tgz&quot;.length());</span>
    }
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">    if (name.toLowerCase(Locale.ENGLISH).endsWith(&quot;.zip&quot;)) {</span>
<span class="fc" id="L149">      return name.substring(0, name.length() - &quot;.zip&quot;.length());</span>
    }
<span class="nc" id="L151">    return name;</span>
  }

  private static String fileName(String url) throws MalformedURLException {
<span class="fc" id="L155">    Path fileName = Path.of(new URL(url).getPath()).getFileName();</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">    if (fileName == null) {</span>
      // SpotBugs: guard against URLs ending with a trailing slash that would trigger an NPE.
<span class="nc" id="L158">      throw new MalformedURLException(&quot;URL does not contain a file name: &quot; + url);</span>
    }
<span class="fc" id="L160">    return fileName.toString();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>